<!--
   -
   - Awesome New Tab Page
   -   Copyright 2011 Michael Hart (http://h4r7.me/).
   - 
   - Want to make it even more awesome?
   -   https://github.com/michaelhart/Awesome-New-Tab-Page/
   -
   - Licensed under GPL v3:
   -   http://www.gnu.org/licenses/gpl-3.0.txt
   -
   -->
<canvas width="128" height="128"></canvas>
<script type="text/javascript">
window.setTimeout(' window.location = window.location; ', 2*60*60*1000);


var recently_closed = JSON.parse(localStorage.getItem("recently_closed")) || [], background_colors = JSON.parse(localStorage.getItem("background_colors")) || {"empty": true};

chrome.tabs.onRemoved.addListener( onRemoved );

function onRemoved(tabId) {
  var tab = tabs.filter(function (tab) { return tab.id === tabId})[0];

  if(!tab || tab.incognito === true) {
    return;
  }

  if(tab.title === "") {
    return;
  }

  recently_closed.unshift({title: tab.title, url: tab.url});

  if(recently_closed.length > 15) {
    recently_closed.pop();
  }

  localStorage.setItem("recently_closed", JSON.stringify( recently_closed ))
  getAllTabs();
}

chrome.tabs.onCreated.addListener( getAllTabs );

var tabs = null;
function getAllTabs() {
  chrome.tabs.getAllInWindow(null, getAllTabs_callback);
}
function getAllTabs_callback(data) {
  tabs = data;
}
chrome.tabs.getAllInWindow(null, getAllTabs);

var recently_installed = null;
chrome.management.onInstalled.addListener( onInstalled );

function onInstalled(ExtensionInfo) {

  recently_installed = ExtensionInfo;

  cacheIconColor(ExtensionInfo);
  
  setTimeout(function() {
    recently_installed = null;
  }, 5000);

}

function setupDrawerWidgets(extensions) {
  e = extensions;
  // $.each(extensions, setupDrawerWidget);
  for(var i in extensions) {
    setupDrawerWidget(i, extensions[i]);
  }

  setTimeout(function() {
    window.location = window.location;
  }, 3000);
};

function setupDrawerWidget(index, value) {
    if(value.type !== "stock") {
      chrome.extension.sendRequest(
        value.id,
        "mgmiemnjjchgkmgbeljfocdjjnpjnmcg-poke"
      );
    }
  }

chrome.extension.onRequestExternal.addListener( onRequestExternal );
function onRequestExternal(request, sender, sendResponse) {
  if(request.head) {
    if(request.head === "mgmiemnjjchgkmgbeljfocdjjnpjnmcg-pokeback") {
      console.log(request, sender);
      respond({
        fn: "setupDrawerWidgets",
        data: {
          "request": request,
          "sender": sender,
        },
      });
    }
  }
}


// Listen to Content Scripts
chrome.extension.onConnect.addListener( onConnect );
function onConnect(port) {
  console.assert(port.name == "NTP-Port");
  port.onMessage.addListener( onMessage );

  respond = function(d) {
    port.postMessage(d);
  }

}

function onMessage(msg) {

  if(!msg.fn || !msg.data) {
    return false;
  }

  if(typeof window[msg.fn] === 'function') {
    window[msg.fn](msg.data);
  } else {
    return false;
  }

}

function cacheIconColor(ExtensionInfo) {
  try {
    if (ExtensionInfo && ExtensionInfo.isApp) {
      var img = new Image();
	  img.onerror = function() {
	    console.warn("Can't get icon for " + ExtensionInfo.id);
	  };
	  img.onload = function() {
        var output = background_colors[ExtensionInfo.id] = getAverageRGB(img);
	    localStorage.setItem("background_colors", JSON.stringify(background_colors));
	  };
	  img.src = "chrome://extension-icon/" + ExtensionInfo.id + "/128/0"
    }
  } catch(e) {
    console.warn("Can't get icon for " + ExtensionInfo.id, e);
  }
}

var canvas = document.querySelector("canvas");

// From http://stackoverflow.com/a/2541680/709376
function getAverageRGB(imgEl) {
  var blockSize = 5,
  defaultRGB = {r:0,g:0,b:0},
  context = canvas.getContext && canvas.getContext('2d'),
  data, width, height,
  i = -4,
  len,
  rgb = {r:0,g:0,b:0},
  count = 0;
  if (!context) {
    return defaultRGB;
  }
  height = canvas.height = imgEl.naturalHeight || imgEl.offsetHeight || imgEl.height;
  width = canvas.width = imgEl.naturalWidth || imgEl.offsetWidth || imgEl.width;
  context.drawImage(imgEl, 0, 0);
  try {
    data = context.getImageData(0, 0, width, height);
  } catch(e) {
    return defaultRGB;
  }
  len = data.data.length;
  while ( (i += blockSize * 4) < len ) {
    ++count;
    rgb.r += data.data[i];
    rgb.g += data.data[i+1];
    rgb.b += data.data[i+2];
  }
  rgb.r = ~~(rgb.r/count);
  rgb.g = ~~(rgb.g/count);
  rgb.b = ~~(rgb.b/count);
  return rgb;
}

if (!localStorage.getItem("background_colors")) localStorage.setItem("background_colors", "{}");
chrome.management.getAll(function(results) {
  for(var i = 0; i < results.length; i++) {
    cacheIconColor(results[i]);
  }
});
</script>